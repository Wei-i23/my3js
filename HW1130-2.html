<html>
<head>
<style>
#info {
  position: absolute;
  width: 100vw;
  text-align: center;
}

body {
  overflow: hidden;
}

</style>
<body>
<div id="info">
<h1 style='color:pink'>sprite & billboard

</div>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

<script type ="module">
javascript:(function(){var script=document.createElement('script');script.onload=function(){var stats=new Stats();document.body.appendChild(stats.dom);requestAnimationFrame(function loop(){stats.update();requestAnimationFrame(loop)});};script.src='https://mrdoob.github.io/stats.js/build/stats.min.js';document.head.appendChild(script);})()

import * as THREE from 'https://unpkg.com/three/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three/examples/jsm/controls/OrbitControls.js';


var camera, scene, renderer, controls;
var uvoffsetArray = [];
var baseS = 0,
	baseT = 0;
var counter = 0;
var animalup,animaldown;

init();
animate();

//排順序
function setUpOffsetArray(){
	var rowCount = 2;
	var colCount = 4;
	for(var i=0;i<rowCount;i++){
		var row = [];
		for(var j=0;j<colCount;j++)
			row.push(new THREE.Vector2(j*0.25 , -0.5*i));
		uvoffsetArray.push(row);
	}
}

function buildSprite(texMat){
	//animaldown
	var geometry = new THREE.Geometry();
	geometry.vertices.push(		//調整動畫大小
		new THREE.Vector3(-8, -8, 0),
		new THREE.Vector3(8, -8, 0),
		new THREE.Vector3(8, 8, 0),
		new THREE.Vector3(-8, 8, 0)
	);

	var face;
	face = new THREE.Face3(0, 1, 2);
	geometry.faces.push(face);
	face = new THREE.Face3(0, 2, 3);
	geometry.faces.push(face);
  
	var uv0 = new THREE.Vector2(0.0,0.5);
	var uv1 = new THREE.Vector2(0.25,0.5);
	var uv2 = new THREE.Vector2(0.25,1.0);
	var uv3 = new THREE.Vector2(0.0,1.0);
  
	geometry.faceVertexUvs[0].push([uv0, uv1, uv2]);
	geometry.faceVertexUvs[0].push([uv0, uv2, uv3]);

	geometry.computeBoundingSphere();
	geometry.computeFaceNormals();
	geometry.computeVertexNormals();

	animaldown = new THREE.Mesh(geometry, texMat);
	scene.add(animaldown);
	animaldown.position.set(-10,-10,0);
	animaldown.rotation.y = Math.PI;

	//animalup
	var geometryup = new THREE.Geometry();
	geometryup.vertices.push(		//調整動畫大小
		new THREE.Vector3(-5, -5, 0),
		new THREE.Vector3(5, -5, 0),
		new THREE.Vector3(5, 5, 0),
		new THREE.Vector3(-5, 5, 0)
	);
	var faceup;
	faceup = new THREE.Face3(0, 1, 2);
	geometryup.faces.push(faceup);
	faceup = new THREE.Face3(0, 2, 3);
	geometryup.faces.push(faceup);
  
	var uv0 = new THREE.Vector2(0.0,0.5);
	var uv1 = new THREE.Vector2(0.25,0.5);
	var uv2 = new THREE.Vector2(0.25,1.0);
	var uv3 = new THREE.Vector2(0.0,1.0);
  
	geometryup.faceVertexUvs[0].push([uv0, uv1, uv2]);
	geometryup.faceVertexUvs[0].push([uv0, uv2, uv3]);

	geometryup.computeBoundingSphere();
	geometryup.computeFaceNormals();
	geometryup.computeVertexNormals();

	animalup = new THREE.Mesh(geometryup, texMat);
	scene.add(animalup);
	animalup.position.set(10,10,0);
	
	
	scene.add(animaldown);
	animaldown.position.set(-10,-10,0);
	animaldown.rotation.y = Math.PI;
	
}

function init() {

	scene = new THREE.Scene();

	camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
	camera.position.z = 100;
	scene.add(camera);
	window.addEventListener('resize', onWindowResize, false);

	renderer = new THREE.WebGLRenderer({antialias:true});	//antialias可以增加抗鉅齒
	renderer.setSize(window.innerWidth, window.innerHeight);
	renderer.setClearColor(0x888888);
	document.body.appendChild(renderer.domElement);

	controls = new OrbitControls(camera, renderer.domElement);
	
	let gridXZ = new THREE.GridHelper(100, 20, 'red', 'white')
	scene.add(gridXZ);
	
	setUpOffsetArray();
	
	var loader = new THREE.TextureLoader();
	loader.crossOrigin = '';
	loader.load('https://i.imgur.com/D4CK3KI.png',
	
		function(texture){
			var texMat = new THREE.MeshBasicMaterial({
				map: texture,
				transparent: true,
				side: THREE.DoubleSide
			});
			texture.wrapS = THREE.RepeatWrapping;
			texture.wrapT = THREE.RepeatWrapping;
			buildSprite(texMat);
			
		},
		function(xhr){
			console.log((xhr.loaded/xhr.total*100)+'% loaded');
		}
	);
	
	//框
	let frameTex = loader.load('https://i.imgur.com/FPdSoRu.png');
	let frameMat = new THREE.MeshBasicMaterial({
		map: frameTex,
		alphaTest: 0.5,	//加了這行就不會有黑色正方形的底
		side: THREE.DoubleSide
	});
	let frame = new THREE.Mesh(new THREE.PlaneGeometry(50,50),frameMat);
	scene.add(frame);
	//frame.position.y = 20;
}

function move(){
	var stepup = counter % 100;
	var stepdown = counter % 100;
	
	if(animalup){
		if(stepup === 0)
			animalup.position.x = 10;
		else
			animalup.position.x -= 0.2;
	}
	if(animaldown){
		if(stepdown === 0)
			animaldown.position.x = -10;
		else
			animaldown.position.x += 0.2;
	}
}

function onWindowResize() {
	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth, window.innerHeight);
}

function spriteAnimate() {
	console.log (uvoffsetArray[baseS][baseT]);
  
	animaldown.material.map.offset.copy (uvoffsetArray[baseS][baseT]);  
	baseT = (baseT + 1) % 4;
	if (baseT === 0) {
    baseS = (baseS + 1) % 2;
	}
	
	animalup.material.map.offset.copy (uvoffsetArray[baseS][baseT]);  
	baseT = (baseT + 1) % 4;
	if (baseT === 0) {
    baseS = (baseS + 1) % 2;
	}
}

function animate() {
	counter++;

	if (counter % 20 === 0)	//調整mod的參數可以讓動畫變快或變慢
		spriteAnimate();

	move();
	
	requestAnimationFrame(animate);
	renderer.render(scene, camera);
}


	


</script>
</body>
</html